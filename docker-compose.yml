services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: edu-cockpit-backend
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./local_logs:/app/local_logs
      - ./app:/app/app
      - ./main.py:/app/main.py
    healthcheck:
      test:
        - CMD-SHELL
        - python -c "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/healthz', timeout=3)"
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
  mysql:
    image: mysql:8.4
    container_name: edu-cockpit-mysql
    restart: unless-stopped
    profiles: ["with-mysql"]
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${DB_NAME:-edu_admin}
      MYSQL_USER: ${DB_USER:-edu_admin}
      MYSQL_PASSWORD: ${DB_PASSWORD:-change_me}
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test:
        - CMD-SHELL
        - mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent
      interval: 10s
      timeout: 5s
      retries: 8
      start_period: 20s

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    container_name: edu-cockpit-web
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "80:80"
    healthcheck:
      test:
        - CMD-SHELL
        - wget -q -O /dev/null http://127.0.0.1/ || exit 1
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  mysql_data:
